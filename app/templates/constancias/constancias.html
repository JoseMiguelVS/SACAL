{% extends './layout.html' %}

{% block body %}
<h2>Datos de constancias</h2>
<br>

<!-- Alertas -->
{% with messages = get_flashed_messages() %}
{% if messages %}
{% for message in messages %}
<div class="alert alert-{% if " Error" in message %}danger{% elif "Advertencia" in message %}warning{% else %}success{%
    endif %} alert-dismissible fade show" role="alert">
    <strong>{{ message }}</strong>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Filtros de búsqueda -->
<div>
    <form method="get" action="{{ url_for('constancias.constancias_buscar') }}" class="d-flex">
        <div class="espacio_form">
            <select name="nombre_categoria" id="nombre_categoria">
                <option value="">-Seleccione la categoria-</option>
                {% if categorias %}
                {% for categoria in categorias %}
                <option value="{{ categoria.1 }}" {% if request.args.get('nombre_categoria')==categoria.1 %}selected{%
                    endif %}>
                    {{ categoria.1 }}
                </option>
                {% endfor %}
                {% else %}
                <option>Aún no hay registros</option>
                {% endif %}
            </select>
        </div>

        <div class="espacio_form">
            <select name="sesion" id="sesion">
                <option value="">-Seleccione la sesión-</option>
                {% if sesiones %}
                {% for sesion in sesiones %}
                <option value="{{ sesion.1 }}" {% if request.args.get('sesion')==sesion.1 %}selected{% endif %}>
                    {{ sesion.7 }} | {{ sesion.1 }}
                </option>
                {% endfor %}
                {% else %}
                <option>Aún no hay registros</option>
                {% endif %}
            </select>
            <button type="submit">Aceptar</button>
        </div>
    </form>
</div>

<!-- Tabla de resultados -->
<div class="tables_participantes">
    <table>
        <thead>
            <tr>
                <th>Ver más</th>
                <th>Generar<br>constancia</th>
                <th>Editar</th>
                <th>Clave<br>Participante</th>
                <th>Nombre<br>Participante</th>
                <th>Curso</th>
                <th>Pago<br>validado</th>
                <th>Constancia<br>generada</th>
                <th>Folio de<br>constancia</th>
                <th>Constancia<br>enviada</th>
                <th>Fecha de<br>envío</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% if constancias %}
            {% for p in constancias %}
            {% if not p.constancia_enviada %}
            <tr data-id="{{ p.id_participante }}">
                <td>
                    <a class=""
                        href="{{ url_for('constancias.constancias_detalles', id=p.id_participante) }}">
                        <li class="fa fa-eye" style="font-size: 18px;"></li>
                    </a>
                </td>
                <td>
                    <a class=""
                        onclick="generarConstancia('{{ p.id_participante }}', '{{ p.nombre_curso }}', '{{ p.fecha }}', '{{ p.curso_id }}')">
                        <li class="fas fa-download" style="font-size: 18px;"></li>
                    </a>
                </td>
                <td>
                    <a class=""
                        href="{{ url_for('constancias.constancias_editar', id=p.id_participante, curso=p.nombre_curso, fecha=p.fecha) }}">
                        <li class="fa fa-edit" style="font-size: 18px;"></li>
                    </a>
                </td>
                <td>{{ p.clave_participante }}</td>
                <td>{{ p.nombre_participante }} {{ p.apellidos_participante }}</td>
                <td>{{ p.nombre_curso }}</td>
                <td>{{ p.validacion_pago }}</td>
                <td><input type="checkbox" {% if p.constancia_generada %}checked{% endif %} disabled></td>

                <form class="d-flex" method="post"
                    action="{{ url_for('constancias.modificar_constancia') }}?id={{ p.id_participante }}&id_curso={{ p.curso_id }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <td><input type="text" name="folio_constancia" value="{{ p.folio_constancia }}"></td>
                    <td><input type="checkbox" name="constancia_enviada" {% if p.constancia_enviada %}checked{% endif
                            %}></td>
                    <td><input type="date" name="fecha_envio" value="{{ p.fecha_envio | default('', true) }}"></td>
                    <td><button type="submit">Guardar</button></td>
                </form>
            </tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
                <td align="center" colspan="12">No existen participantes</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Botón para ver constancias generadas -->
<div>
    <br>
    <a href="{{ url_for('constancias.constancias_hechas') }}"
        class="btn btn-outline-danger d-inline-flex align-items-center">
        <li class="fa fa-folder" style="font-size: 18px;"></li>
    </a>
</div>

<!-- Script para generación de constancia -->
<script>
    function generarConstancia(id, curso, fecha, id_curso) {
        const url = `/constancias/constancia?id=${id}&curso=${encodeURIComponent(curso)}&fecha=${fecha}&id_curso=${id_curso}`;
        window.open(url, '_blank');
        setTimeout(() => {
            location.reload();
        }, 2000);
    }
</script>
{% endblock %}