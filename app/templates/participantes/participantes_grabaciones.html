{% extends './layout.html' %} {% block body %}
<main class="w-100 d-flex flex-column" style="margin: -1px; padding: 0;">

    <!-- TÍTULO -->
    <h2 class="text-center mb-4">Participantes en grabaciones</h2>

    <!-- -----------------Alertas de registro, editado, borrado y restaurado---------------------------- -->
    {% with messages = get_flashed_messages() %} {% if messages %} {% for
    message in messages %}
    <div class="alert alert-dismissible fade show alert-fixed {% if 'Error' in message %}alert-danger{% elif 'Advertencia' in message %}alert-warning{% else %}alert-success{% endif %}"
        role="alert">
        <strong>{{ message }}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %} {% endif %} {% endwith %}

    <section class="container mb-4 d-flex justify-content-center gap-3">
        <!-- Botón en vivos -->
        <a href="{{ url_for('participantes.participantes_buscar') }}" class="botones-guardar btn-sm">En vivos</a>

        <a href="{{ url_for('participantes.participantes_especializacion_buscar') }}"
            class="botones-guardar btn-sm">Especializacion</a>

        <a href="{{ url_for('participantes.participantes_especializacionP_buscar') }}"
            class="botones-guardar btn-sm">Especializacion Pasadas</a>
    </section>

    <!-- NUEVO + BUSCADOR -->
    <section class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <button type="button" class="botones m-2" data-bs-toggle="modal" data-bs-target="#modalAgregarParticipante">
            <i class="fa fa-plus mr-2"></i> Nuevo
        </button>
        <!-- Buscador por clave a la derecha -->
        <form id="formBuscar" method="get" action="{{ url_for('participantes.participantes_grabaciones_buscar') }}"
            class="d-flex flex-grow-1 justify-content-end">
            <div class="input-group mr-2" style="max-width: 300px;">
                <input class="form-control mr-2" type="text" name="buscar" value="{{ search_query }}"
                    placeholder="Buscar..." aria-label="Buscar participante por clave o nombre" required
                    onchange="document.getElementById('formBuscar').submit()" />
                <button type="submit" class="botones-ver ms-2" aria-label="Buscar">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </section>

    <!-- FILTROS CENTRADOS ABAJO -->
    <section class="container mb-4">
        <!-- Filtros principales (Mes, Semana, Sesión, Equipo, Fechas) -->
        <form method="get" action="{{ url_for('participantes.participantes_grabaciones_filtros') }}"
            class="row g-3 align-items-end" id="filtroForm">

            <!-- Equipo -->
            <div class="col-sm-2">
                <label for="filtroEquipo" class="form-label">Equipo</label>
                <select id="filtroEquipo" name="equipos" class="form-select form-select-sm filtro-auto">
                    <option value="">Todos</option>
                    {% for equipo in equipos %}
                    {% set valorEquipo = equipo.0 ~ ',' ~ equipo.1 %}
                    <option value="{{ valorEquipo }}" {% if request.args.get('equipos', '' ).split(',')[-1]==equipo.1
                        %}selected{% endif %}>
                        {{ equipo.1 }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Fecha inicio -->
            <div class="col-sm-2">
                <label for="fecha_inicio" class="form-label">Fecha inicio</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control form-control-sm"
                    value="{{ request.args.get('fecha_inicio', '') }}">
            </div>

            <!-- Fecha fin -->
            <div class="col-sm-2">
                <label for="fecha_fin" class="form-label">Fecha fin</label>
                <input type="date" id="fecha_fin" name="fecha_fin" class="form-control form-control-sm filtro-auto"
                    value="{{ request.args.get('fecha_fin', '') }}">
            </div>

            <!-- Segunda fila: Limpiar + Grabaciones -->
            <div class="col-12 d-flex align-items-center gap-4 mt-2">
                <!-- Botón limpiar -->
                <a href="{{ url_for('participantes.participantes_grabaciones_buscar') }}"
                    class="btn btn-outline-secondary btn-sm">Limpiar</a>

            </div>
        </form>
    </section>


    <!-- TABLA DE PARTICIPANTES -->
    <section class="tables_participantes table">
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle text-nowrap">
                <thead class="table-light small">
                    <tr>
                        <th>Clave</th>
                        <th>Telefono</th>
                        <th>Nombre</th>
                        <th>Apellidos</th>
                        <th>Paquete</th>
                        <th>Pago<br>validado</th>
                        <th>Fecha del<br>pago</th>
                        <th>Factura</th>
                        <th>Curso</th>
                        <th>Cuenta<br>Destino</th>
                        <th>Promotor</th>
                        <th>WhatsApp</th>
                        <th>Materiales</th>
                        <th>Grabaciones</th>
                        <th>Evaluación<br>recibida</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody class="small">
                    {% if participantes %}
                    {% for p in participantes %}
                    {% if p.estado == True %}
                    <tr data-id="{{ p.id_participante }}">
                        <td><input type="text" name="clave_participante" value="{{ p.clave_participante }}"
                                onchange="guardarFila(this)"></td>
                        <td><input type="text" name="num_telefono" value="{{ p.num_telefono }}"
                                onchange="guardarFila(this)"></td>
                        <td><input type="text" name="nombre_participante" value="{{ p.nombre_participante }} "
                                onchange="guardarFila(this)"></td>
                        <td><input type="text" name="apellidos_participante" value="{{ p.apellidos_participante }}"
                                onchange="guardarFila(this)">
                        </td>
                        <td>
                            <select name="nombre_paquete" id="nombre_paquete" onchange="guardarFila(this)">
                                <option value="true" selected>Paquete</option>
                                {% if paquetes %}
                                {% for paquete in paquetes %}
                                <option value="{{ paquete.0 }}" {% if paquete.1|string==p.nombre_paquete|string
                                    %}selected{% endif %}>{{ paquete.1 }}</option>
                                {% endfor %}
                                {% else %}
                                <option>Aún no hay registros</option>
                                {% endif %}
                            </select>
                        </td>
                        <td>
                            {% if p.validacion_pago == 3 %}
                            Validado
                            {% elif p.validacion_pago == 2 %}
                            Pendiente
                            {% else %}
                            No encontrado
                            {% endif %}
                        </td>
                        <td><input type="date" name="fecha_pago" value="{{ p.fecha_pago }}"
                                onchange="guardarFila(this)"></td>

                        <td>
                            <input type="checkbox" name="factura_pago" onchange="guardarFila(this)" {% if p.factura_pago
                                %}checked{% endif %}>
                        </td>

                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ p.cursos }}
                        </td>

                        <td>
                            <select name="cuenta_destino" id="cuenta_destino" onchange="guardarFila(this)">
                                <option value="" disabled {% if not p.cuenta_destino %}selected{% endif %}>Cuenta
                                    destino
                                </option>
                                {% if cuentas %}
                                {% for cuenta in cuentas %}
                                <option value="{{ cuenta.0 }}" {% if cuenta.1|string==p.cuenta_destino|string
                                    %}selected{% endif %}>{{ cuenta.1 }}</option>
                                {% endfor %}
                                {% else %}
                                <option>Aún no hay registros</option>
                                {% endif %}
                            </select>
                        </td>
                        <td>{{ p.nombre_empleado }}</td>
                        <td><input type="checkbox" name="confirmacion_grupo" onchange="guardarFila(this)" {% if
                                p.confirmacion_grupo %}checked{% endif %}>
                        </td>
                        <td><input type="checkbox" name="materiales" onchange="guardarFila(this)" {% if p.materiales
                                %}checked{% endif %}></td>
                        <td><input type="checkbox" name="grabaciones" onchange="guardarFila(this)" {% if p.grabaciones
                                %}checked{% endif %}></td>
                        <td><input type="checkbox" name="evaluacion_dc3" onchange="guardarFila(this)" {% if
                                p.evaluacion_dc3 %}checked{% endif %}>
                        </td>
                        <td><input type="text" name="observaciones" onchange="guardarFila(this)"
                                value="{{ p.observaciones }}"></td>
                        <td>
                            <button type="button" class="botones-editar" data-bs-toggle="modal"
                                data-bs-target="#modalEditar-{{p.id_participante}}"
                                aria-label="Editar participante {{ p.nombre_participante }}">
                                <i class="fa fa-edit" style="font-size: 14px"></i>
                            </button>

                            <button type="button" class="botones-editar" data-bs-toggle="modal"
                                data-bs-target="#modalComprobante-{{p.id_participante}}"
                                aria-label="Editar participante {{ p.nombre_participante }}">
                                <i class="fas fa-receipt" style="font-size: 14px"></i>
                            </button>
                        </td>
                        <!-- <td><button onclick="guardarCambios(this)">Guardar</button></td> -->
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td align="center" colspan="15">No existen participantes</td>
                    </tr>
                    {% endif %}

                </tbody>
            </table>
        </div>
    </section>

    <div class="modal fade" id="modalAgregarParticipante" data-bs-backdrop="static" data-bs-keyboard="false"
        tabindex="-1" aria-labelledby="modalAgregarParticipanteLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <form action="{{ url_for('participantes.participante_nuevoG') }}" method="post" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAgregarParticipanteLabel">Agregar Participante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="nombre_empleado" value="{{ current_user.id_empleado }}">

                    {# Extraer partes de la fecha solo si existen #}
                    {% set fecha_raw = request.args.get('fecha', '') %}
                    {% set partesSesiones = fecha_raw.split('/') if fecha_raw else [] %}

                    {% if partesSesiones|length == 3 %}
                    <input type="hidden" name="id_sesion" id="id_sesion" value="{{ partesSesiones[0] }}">
                    <p><strong>Sesión:</strong> {{ partesSesiones[1] }}, {{ partesSesiones[2] }}</p>
                    {% endif %}
                    <input type="hidden" name="fecha" value="{{ fecha_raw }}">

                    {% set partes_equipo = request.args.get('equipos', '').split(',') %}
                    {% if partes_equipo | length == 2 %}
                    <input type="hidden" name="equipos" id="equipos" value="{{ partes_equipo[0] }}">
                    <p><strong>Equipo:</strong> {{ partes_equipo[1] }}</p>
                    {% endif %}


                    <input type="hidden" name="mes" value="{{ request.args.get('mes', '') }}">
                    <input type="hidden" name="equipos_filtro" value="{{ request.args.get('equipos', '') }}">
                    <input type="hidden" name="semana" value="{{ request.args.get('semana', '') }}">
                    <div class="modal-body">

                        <div>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="nombre_empleado" value="{{ current_user.id_empleado }}">

                            {# Extraer partes de la fecha solo si existen #}
                            {% set fecha_raw = request.args.get('fecha', '') %}
                            {% set partesSesiones = fecha_raw.split('/') if fecha_raw else [] %}


                            <input type="hidden" name="fecha" value="{{ fecha_raw }}" required>
                            {% set partes_equipo = request.args.get('equipos', '').split(',') %}
                            {% if partes_equipo | length == 2 %}
                            <input type="hidden" name="equipos" id="equipos" value="{{ partes_equipo[0] }}" required>
                            <p><strong>Equipo:</strong> {{ partes_equipo[1] }}</p>
                            {% endif %}
                            <input type="hidden" name="mes" value="{{ request.args.get('mes', '') }}" required>
                            <input type="hidden" name="semana" value="{{ request.args.get('semana', '') }}" required>
                        </div>

                        <div class="row justify-content-center g-3">

                            <!-- Clave -->
                            <div class="input-group justify-content-center">
                                <div class="col-md-6">
                                    <input type="text" id="clave_participante" name="clave_participante"
                                        class="input-field" placeholder="Ej: {{ clave_anterior }}" required>
                                    <label for="clave_participante" class="input-label">Clave de participante</label>
                                </div>
                            </div>

                            <!-- Teléfono -->
                            <div class="input-group justify-content-center">
                                <div class="col-md-6">
                                    <input type="text" id="num_telefono" name="num_telefono" class="input-field"
                                        placeholder="" required>
                                    <label for="num_telefono" class="input-label">Número de teléfono</label>
                                </div>
                            </div>

                            <!-- Nombre -->
                            <div class="input-group justify-content-center">
                                <div class="col-md-6">
                                    <input type="text" id="nombre_participante" name="nombre_participante"
                                        class="input-field" placeholder="" required>
                                    <label for="nombre_participante" class="input-label">Nombre del participante</label>
                                </div>
                            </div>

                            <!-- Apellidos -->
                            <div class="input-group justify-content-center">
                                <div class="col-md-6">
                                    <input type="text" id="apellidos_participante" name="apellidos_participante"
                                        class="input-field" placeholder="" required>
                                    <label for="apellidos_participante" class="input-label">Apellidos del
                                        participante</label>
                                </div>
                            </div>

                            <div class="input-group justify-content-center">
                                <select name="paquete" id="paquete" class="form-select" required
                                    style="max-width: 360px;">
                                    <option value="" selected disabled>Selecciona un paquete</option>
                                    {% if paquetes %}
                                    {% set espe = 2 %}
                                    {% for paquete in paquetes %}
                                    {% if (paquete[4]) and (paquete[3] == espe) %}
                                    <option value="{{ paquete[0] }},{{ paquete[2] }}">
                                        {{ paquete[1] }} — ${{ paquete[2] }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                    {% else %}
                                    <option disabled>No hay paquetes disponibles</option>
                                    {% endif %}
                                </select>
                            </div>

                            <div class="input-group justify-content-center">
                                <div class="col-sm-4">
                                    <select id="id_sesion" name="id_sesion" style="max-width: 360px;"
                                        class="form-select select-buscable" required>
                                        <option value="">Seleccione una grabacion</option>
                                        {% set categoria = 3 %}
                                        {% set equipo_sel = request.args.get('equipos', '') %}
                                        {% set mes_sel = request.args.get('mes', '') %}
                                        {% set semana_sel = request.args.get('semana', '') %}
                                        {% set fecha_actual = request.args.get('fecha', '') %}
                                        {% for sesion in sesiones %}
                                        {% if (mes_sel == '' or sesion.4 == mes_sel) and
                                        (semana_sel == '' or sesion.3 == semana_sel) and
                                        (sesion.7 == categoria) %}
                                        <option value="{{ sesion.0 }}" {% if fecha_actual==valor %}selected{% endif %}>
                                            {{ sesion.5 }}
                                        </option>
                                        {% endif %}
                                        {% endfor %}

                                    </select>
                                </div>

                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="botones" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="botones-guardar">Guardar</button>
                    </div>
            </form>
        </div>
    </div>

    <!-- -------------------------------------------------PAGINADOR----------------------------------------------- -->
    <nav class="pagination-container mt-4" aria-label="Page navigation" class="justify-content-center">
        <ul class="pagination justify-content-center" style="margin:20px 0">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link bg-warning"
                    href="{{url_for('participantes.participantes_grabaciones_buscar')}}?page={{ page - 1 }}&per_page={{ per_page }}"
                    aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% if page != 1 and page != 2 %}
            <li class="page-item"><a class="page-link bg-warning"
                    href="{{url_for('participantes.participantes_grabaciones_buscar')}}">1</a></li>
            {% if page != 3 %}
            <li class="page-item"><a class="page-link disabled bg-warning">...</a></li>
            {% endif %}
            {% endif %}
            <li class="page-item"><a class="page-link bg-warning"
                    href="{{url_for('participantes.participantes_grabaciones_buscar')}}?page={{ page - 1 }}&per_page={{ per_page }}">{{page-1}}</a>
            </li>
            {% endif %}

            <li class="page-item"><a class="page-link active bg-warning" href="#">{{page}}</a></li>

            {% if page < total_pages %} <li class="page-item"><a class="page-link bg-warning"
                    href="{{url_for('participantes.participantes_grabaciones_buscar')}}?page={{ page + 1 }}&per_page={{ per_page }}">{{page+1}}</a>
                </li>
                {% if page != total_pages and page != total_pages-1 %}
                {% if page != total_pages-2 %}
                <li class="page-item"><a class="page-link disabled bg-warning">...</a></li>
                {% endif %}
                <li class="page-item"><a class="page-link bg-warning"
                        href="{{url_for('participantes.participantes_grabaciones_buscar')}}?page={{ total_pages }}&per_page={{ per_page }}">{{total_pages}}</a>
                </li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link bg-warning"
                        href="{{url_for('participantes.participantes_grabaciones_buscar')}}?page={{ page + 1 }}&per_page={{ per_page }}"
                        aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% endif %}
        </ul>
    </nav>

</main>

<script>
    document.getElementById('flexSwitchCheckDefault').addEventListener('change', function () {
        if (this.checked) {
            window.location.href = '{{ url_for("participantes.participantes_buscar") }}';
            this.checked = false;
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const inputBuscar = document.querySelector("input[name='buscar']");
        const form = document.getElementById("formBuscar");

        inputBuscar.addEventListener("change", function () {
            form.submit();
        });
    });
</script>

<script>
    function guardarFila(elemento) {
        const fila = elemento.closest('tr');
        const id = fila.dataset.id;
        const datos = {};

        fila.querySelectorAll('input, select').forEach(el => {
            if (el.type === 'checkbox') {
                datos[el.name] = el.checked;
            } else {
                datos[el.name] = el.value;
            }
        });

        fetch(`/participantesG/actualizar/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'  // Si estás usando CSRF con Flask-WTF
            },
            body: JSON.stringify(datos)
        })
            .then(res => res.json())
            .then(data => {
                console.log(data.alert);
                // Aquí podrías mostrar una notificación visual si deseas
            })
            .catch(error => {
                console.error('Error al guardar:', error);
                alert('Error al guardar los cambios');
            });
    }
</script>

<script>
    let debounceTimeout = null;

    document.querySelectorAll('.filtro-auto').forEach(select => {
        select.addEventListener('change', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                document.getElementById('filtroForm').submit();
            }, 400); // Espera 400ms tras el último cambio
        });
    });


</script>

{% endblock %}