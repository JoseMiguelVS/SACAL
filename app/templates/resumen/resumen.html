{% extends './layout.html' %}
{% block body %}
<main class="w-100 d-flex flex-column">
    <h2 class="text-center mb-4">Resumen semanal</h2>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-dismissible fade show alert-fixed 
                {% if 'Error' in message %}alert-danger
                {% elif 'Advertencia' in message %}alert-warning
                {% else %}alert-success{% endif %}" role="alert">
        <strong>{{ message }}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Filtro de fechas -->
    <section class="d-flex justify-content-center align-items-center flex-wrap gap-3 mb-3">
        <form method="get" action="{{ url_for('resumen_semanal.resumen') }}"
            class="d-flex flex-wrap align-items-center gap-2" id="filtroForm">
            <div class="d-flex flex-column">
                <label for="fechaInicio" class="form-label mb-1">Fecha inicio</label>
                <input type="date" id="fechaInicio" name="fecha_inicio" class="form-control form-control-sm"
                    value="{{ fecha_inicio }}">
            </div>
            <div class="d-flex flex-column">
                <label for="fechaFin" class="form-label mb-1">Fecha fin</label>
                <input type="date" id="fechaFin" name="fecha_fin" class="form-control form-control-sm filtro-auto"
                    value="{{ fecha_fin }}">
            </div>
        </form>
        <a href="{{ url_for('resumen_semanal.resumen') }}" class="botones ml-2">Limpiar</a>
    </section>

    <!-- Tabla por categorÃ­as -->
    <section class="tables_participantes table">
        <div class="table-responsive">
            {% for categoria in categorias %}
            {% set categoria_id = categoria[0] %}
            {% set categoria_nombre = categoria[1] %}
            {% set cursos_categoria = cursos_por_categoria[categoria_id] if categoria_id in cursos_por_categoria else []
            %}

            <h4 class="text-center my-4">Cursos en {{ categoria_nombre }}</h4>
            <table class="table table-hover table-bordered align-middle text-nowrap">
                <thead class="table-light small">
                    <tr>
                        <th>Fecha</th>
                        <th>Ponente</th>
                        <th>Curso</th>
                        <th>Paquete / Precio</th>
                        <th>Promesas</th>
                        <th>Pagos</th>
                        <th>Ingreso estimado</th>
                        <th>Total Generado</th>
                        <th>Publicidad</th>
                        <th>Gasto Ponente</th>
                        <th>IVA</th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody class="small">
                    {% if cursos_categoria %}
                    {% for f in cursos_categoria %}
                    {% set paquete_count = f.paquetes | length %}
                    {% for p in f.paquetes %}
                    <tr>
                        {% if loop.first %}
                        <td rowspan="{{ paquete_count }}">{{ f.fecha_obj }}</td>
                        <td rowspan="{{ paquete_count }}">{{ f.nombre_ponente }}</td>
                        <td rowspan="{{ paquete_count }}">{{ f.nombre_curso }}</td>
                        {% endif %}

                        <td>{{ p.nombre_paquete }}: ${{ p.precio_paquete | round(2) }}</td>
                        <td>{{ p.total_promesas }}</td>
                        <td>{{ p.total_pagados }}</td>
                        <td>${{ (p.total_pagados * p.precio_paquete) | round(2) }}</td>

                        {% if loop.first %}
                        <td rowspan="{{ paquete_count }}">${{ f.total_generado | round(2) }}</td>
                        <td rowspan="{{ paquete_count }}">${{ f.publicidad | round(2) }}</td>
                        <td rowspan="{{ paquete_count }}">${{ f.gasto_ponente | round(2) }}</td>
                        <td rowspan="{{ paquete_count }}">${{ f.iva | round(2) }}</td>
                        <td rowspan="{{ paquete_count }}">${{ (f.total_generado - f.publicidad - f.gasto_ponente -
                            f.iva) | round(2) }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="12" class="text-center text-muted">Sin registros</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            {% endfor %}
        </div>
    </section>


    <!-- Totales generales -->
    <section class="table-responsive table-sm">
        <table class="table table-bordered text-end align-middle" style="width: auto;">
            <tr>
                <td>suma total</td>
                <td class="bg-success text-white fw-bold">${{ suma_total | float | round(2) }}</td>
                <td>${{ publicidad_total | float | round(2) }}</td>
                <td class="text-start">publicidad</td>
            </tr>
            <tr>
                <td>meta</td>
                <td>${{ meta | float | round(2) }}</td>
                <td>${{ honorarios | float | round(2) }}</td>
                <td class="text-start">honorarios</td>
            </tr>
            <tr>
                <td>gasto semanal</td>
                <td>${{ gasto_semanal | float | round(2) if gasto_semanal is defined else 0 }}</td>
                <td>${{ iva | float | round(2) }}</td>
                <td class="text-start">iva</td>
            </tr>
            <tr>
                <td>falta</td>
                <td>${{ ingreso_faltante | float | round(2) }}</td>
                <td>${{ sueldos | float | round(2) }}</td>
                <td class="text-start">sueldos</td>
            </tr>
            <tr>
                <td colspan="2"></td>
                <td class="fw-bold">${{ total_gastos | float | round(2) }}</td>
                <td class="text-start fw-bold">suma total gastos</td>
            </tr>
            <tr>
                <td class="bg-danger text-white text-center fw-bold">1000</td>
                <td class="bg-danger text-white fw-bold text-center">{{ porcentaje | round(1) }}%</td>
                <td class="bg-primary text-white fw-bold">${{ ingreso_faltante | float | round(2) }}</td>
                <td class="text-start fw-bold">ingreso faltante</td>
            </tr>
        </table>
    </section>
</main>

<script>
    let debounceTimeout = null;
    document.querySelectorAll('.filtro-auto').forEach(select => {
        select.addEventListener('change', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                document.getElementById('filtroForm').submit();
            }, 400);
        });
    });
</script>
{% endblock %}